#!/usr/bin/env bash
#
# vm-start - Start Vultr VM and connect via mosh
#
# Usage: vm-start [--no-connect]
#
# Environment variables:
#   VULTR_API_KEY     - Your Vultr API key
#   VULTR_INSTANCE_ID - Your VM instance ID
#   TAILSCALE_IP      - Tailscale IP of the VM
#   SSH_PORT          - Custom SSH port (default: 22)

set -euo pipefail

# Configuration (override via environment or config file)
CONFIG_FILE="${HOME}/.config/claude-mobile/config"
[[ -f "$CONFIG_FILE" ]] && source "$CONFIG_FILE"

VULTR_API_KEY="${VULTR_API_KEY:-}"
VULTR_INSTANCE_ID="${VULTR_INSTANCE_ID:-}"
TAILSCALE_IP="${TAILSCALE_IP:-}"
SSH_PORT="${SSH_PORT:-22}"
SSH_USER="${SSH_USER:-$(whoami)}"
CONNECT="${1:-}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

log() { echo -e "${GREEN}[+]${NC} $1"; }
warn() { echo -e "${YELLOW}[!]${NC} $1"; }
error() { echo -e "${RED}[âœ—]${NC} $1" >&2; }

check_requirements() {
    local missing=()
    command -v curl &>/dev/null || missing+=("curl")
    command -v jq &>/dev/null || missing+=("jq")
    command -v mosh &>/dev/null || missing+=("mosh")

    if [[ ${#missing[@]} -gt 0 ]]; then
        error "Missing required tools: ${missing[*]}"
        exit 1
    fi

    if [[ -z "$VULTR_API_KEY" ]]; then
        error "VULTR_API_KEY not set. Add it to $CONFIG_FILE"
        exit 1
    fi

    if [[ -z "$VULTR_INSTANCE_ID" ]]; then
        error "VULTR_INSTANCE_ID not set. Add it to $CONFIG_FILE"
        exit 1
    fi
}

get_instance_status() {
    curl -s "https://api.vultr.com/v2/instances/${VULTR_INSTANCE_ID}" \
        -H "Authorization: Bearer ${VULTR_API_KEY}" | jq -r '.instance.status'
}

get_instance_power() {
    curl -s "https://api.vultr.com/v2/instances/${VULTR_INSTANCE_ID}" \
        -H "Authorization: Bearer ${VULTR_API_KEY}" | jq -r '.instance.power_status'
}

start_instance() {
    log "Starting VM instance..."
    curl -s -X POST "https://api.vultr.com/v2/instances/${VULTR_INSTANCE_ID}/start" \
        -H "Authorization: Bearer ${VULTR_API_KEY}" > /dev/null
}

wait_for_tailscale() {
    log "Waiting for Tailscale connectivity..."
    local max_attempts=60
    local attempt=0

    while [[ $attempt -lt $max_attempts ]]; do
        if ping -c 1 -W 2 "$TAILSCALE_IP" &>/dev/null; then
            log "Tailscale connected!"
            return 0
        fi
        ((attempt++))
        printf "."
        sleep 2
    done

    echo ""
    error "Timeout waiting for Tailscale connection"
    return 1
}

wait_for_ssh() {
    log "Waiting for SSH to be ready..."
    local max_attempts=30
    local attempt=0

    while [[ $attempt -lt $max_attempts ]]; do
        if nc -z -w 2 "$TAILSCALE_IP" "$SSH_PORT" 2>/dev/null; then
            log "SSH ready!"
            return 0
        fi
        ((attempt++))
        printf "."
        sleep 2
    done

    echo ""
    error "Timeout waiting for SSH"
    return 1
}

connect_mosh() {
    log "Connecting via mosh..."
    if [[ "$SSH_PORT" != "22" ]]; then
        exec mosh --ssh="ssh -p ${SSH_PORT}" "${SSH_USER}@${TAILSCALE_IP}"
    else
        exec mosh "${SSH_USER}@${TAILSCALE_IP}"
    fi
}

main() {
    check_requirements

    local power_status
    power_status=$(get_instance_power)

    if [[ "$power_status" == "running" ]]; then
        log "VM is already running"
    else
        start_instance
        sleep 5
    fi

    # Wait for connectivity
    wait_for_tailscale
    wait_for_ssh

    if [[ "$CONNECT" != "--no-connect" ]]; then
        connect_mosh
    else
        log "VM is ready. Connect manually with:"
        echo "  mosh --ssh=\"ssh -p ${SSH_PORT}\" ${SSH_USER}@${TAILSCALE_IP}"
    fi
}

main "$@"
