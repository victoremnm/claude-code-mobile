#!/usr/bin/env bash
#
# vm-status - Check Vultr VM status and cost
#
# Usage: vm-status [--json]

set -euo pipefail

# Configuration
CONFIG_FILE="${HOME}/.config/claude-mobile/config"
[[ -f "$CONFIG_FILE" ]] && source "$CONFIG_FILE"

VULTR_API_KEY="${VULTR_API_KEY:-}"
VULTR_INSTANCE_ID="${VULTR_INSTANCE_ID:-}"
OUTPUT_FORMAT="${1:-}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m'

check_requirements() {
    if [[ ! -f "$CONFIG_FILE" ]]; then
        echo -e "${RED}Error:${NC} Config file not found at $CONFIG_FILE" >&2
        echo "Create it with:" >&2
        echo "  mkdir -p ~/.config/claude-mobile" >&2
        echo "  cp config/config.example ~/.config/claude-mobile/config" >&2
        exit 1
    fi

    if [[ -z "$VULTR_API_KEY" ]]; then
        echo -e "${RED}Error:${NC} VULTR_API_KEY not set in $CONFIG_FILE" >&2
        exit 1
    fi

    if [[ -z "$VULTR_INSTANCE_ID" ]]; then
        echo -e "${RED}Error:${NC} VULTR_INSTANCE_ID not set in $CONFIG_FILE" >&2
        exit 1
    fi

    # Validate instance ID format (should be UUID, not IP)
    if [[ "$VULTR_INSTANCE_ID" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
        echo -e "${RED}Error:${NC} VULTR_INSTANCE_ID looks like an IP address" >&2
        echo "It should be a UUID like: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" >&2
        echo "Find it in the Vultr dashboard URL or run:" >&2
        echo "  curl -s 'https://api.vultr.com/v2/instances' -H 'Authorization: Bearer \$VULTR_API_KEY' | jq '.instances[] | {id, main_ip}'" >&2
        exit 1
    fi
}

get_instance_info() {
    curl -s "https://api.vultr.com/v2/instances/${VULTR_INSTANCE_ID}" \
        -H "Authorization: Bearer ${VULTR_API_KEY}"
}

get_billing_info() {
    curl -s "https://api.vultr.com/v2/billing/history" \
        -H "Authorization: Bearer ${VULTR_API_KEY}" | head -50
}

main() {
    check_requirements

    local info
    info=$(get_instance_info)

    # Check for API errors
    if echo "$info" | jq -e '.error' > /dev/null 2>&1; then
        local error_msg
        error_msg=$(echo "$info" | jq -r '.error')
        echo -e "${RED}Error:${NC} Vultr API error: $error_msg" >&2
        if [[ "$error_msg" == *"Unauthorized"* ]]; then
            echo "Check your VULTR_API_KEY and ensure your IP is whitelisted (or disable IP restrictions)" >&2
        fi
        exit 1
    fi

    if [[ "$OUTPUT_FORMAT" == "--json" ]]; then
        echo "$info" | jq '.'
        exit 0
    fi

    local label plan region power_status main_ip vcpu ram disk
    label=$(echo "$info" | jq -r '.instance.label')
    plan=$(echo "$info" | jq -r '.instance.plan')
    region=$(echo "$info" | jq -r '.instance.region')
    power_status=$(echo "$info" | jq -r '.instance.power_status')
    main_ip=$(echo "$info" | jq -r '.instance.main_ip')
    vcpu=$(echo "$info" | jq -r '.instance.vcpu_count')
    ram=$(echo "$info" | jq -r '.instance.ram')
    disk=$(echo "$info" | jq -r '.instance.disk')

    echo ""
    echo -e "${CYAN}╔══════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║${NC}          VM Status                       ${CYAN}║${NC}"
    echo -e "${CYAN}╚══════════════════════════════════════════╝${NC}"
    echo ""
    echo -e "  ${CYAN}Label:${NC}    $label"
    echo -e "  ${CYAN}Plan:${NC}     $plan"
    echo -e "  ${CYAN}Region:${NC}   $region"
    echo -e "  ${CYAN}Specs:${NC}    ${vcpu} vCPU, ${ram}MB RAM, ${disk}GB disk"
    echo -e "  ${CYAN}Public IP:${NC} $main_ip"
    echo ""

    if [[ "$power_status" == "running" ]]; then
        echo -e "  ${CYAN}Status:${NC}   ${GREEN}● Running${NC}"
        echo -e "  ${CYAN}Cost:${NC}     ~\$0.29/hr (\$7/day)"
    else
        echo -e "  ${CYAN}Status:${NC}   ${RED}○ Stopped${NC}"
        echo -e "  ${CYAN}Cost:${NC}     \$0 (billing paused)"
    fi
    echo ""
}

main "$@"
